<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø§Ù„Ù…Ù†Ù‚Ø° Ø§Ù„Ø°ÙƒÙŠ â€” Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹ (ÙˆØ§ØªØ³Ø§Ø¨)</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#d93b3b">

<style>
  :root{--accent:#d93b3b;--muted:#666}
  *{box-sizing:border-box}
  body{font-family:"Tajawal",system-ui,sans-serif;direction:rtl;margin:0;background:#fff;padding:18px;color:#111;display:flex;justify-content:center}
  .wrap{width:100%;max-width:840px}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{color:var(--accent);margin:0;font-size:1.15rem}
  small{color:var(--muted)}
  .card{background:#fff;border:1px solid #f3eaea;padding:14px;border-radius:10px;margin-top:12px;box-shadow:0 4px 16px rgba(0,0,0,0.03)}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input,textarea,select,button{font-size:1rem}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e9e9e9}
  textarea{min-height:70px;resize:vertical}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:#f6f6f6;color:#222;border:1px solid #eee}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.95rem}
  th,td{padding:8px;border-bottom:1px solid #f4f4f4;text-align:right}
  th{color:var(--accent);font-weight:700}
  .note{color:var(--muted);font-size:0.9rem;margin-top:8px}
  .status-badge{font-size:0.9rem;padding:6px 8px;border-radius:8px;background:#f6f6f6;color:#222}
  @media(max-width:520px){.row{flex-direction:column}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸš¨ Ø§Ù„Ù…Ù†Ù‚Ø° Ø§Ù„Ø°ÙƒÙŠ â€” Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹</h1>
      <small>Ù†Ø³Ø®Ø© PWA: ØªØ«Ø¨ÙŠØª ÙˆØªØªØ¨Ù‘Ø¹ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© ÙˆØ¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ</small>
    </header>

    <!-- Auth card -->
    <div id="auth" class="card">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input id="username" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§"/>
      <label style="margin-top:8px">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ù…Ø­Ù„ÙŠ)</label>
      <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"/>
      <div class="row" style="margin-top:10px">
        <button id="register" class="btn">Ø³Ø¬Ù‘Ù„</button>
        <button id="login" class="btn ghost">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <p class="note">Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ. Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØªØ°ÙƒØ±Ùƒ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².</p>
    </div>

    <!-- Main panel -->
    <div id="panel" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong id="who"></strong>
          <div style="margin-top:6px"><span id="status" class="status-badge">Ø¬Ø§Ù‡Ø²</span></div>
        </div>
        <div class="row">
          <button id="logout" class="btn ghost">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <!-- emergency message -->
      <div style="margin-top:12px">
        <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø³ØªÙØ±Ø³Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ / SMS)</label>
        <textarea id="emergencyText" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù‡Ù†Ø§. Ù…Ø«Ø§Ù„: Ø£Ù†Ø§ Ù…Ø±ÙŠØ¶ Ø³ÙƒØ±ØŒ Ø£Ø­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙˆØ±Ù‹Ø§!"></textarea>
        <div class="note">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªÙÙØªØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹.</div>
      </div>

      <!-- contacts -->
      <div style="margin-top:12px">
        <label>Ø£Ø¶Ù Ø±Ù‚Ù… (Ø¨Ø¯ÙˆÙ† +)</label>
        <div class="row">
          <input id="c_name" placeholder="Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ù„Ø§Ù‹: Ø£Ù…Ù‘ÙŠ)"/>
          <input id="c_phone" placeholder="Ø±Ù‚Ù… Ø¨ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ© Ø¨Ø¯ÙˆÙ† +" />
          <button id="addContact" class="btn">Ø£Ø¶Ù</button>
        </div>

        <table id="contactsTable">
          <thead><tr><th>Ø¥Ø®ØªØ±</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø­Ø°Ù</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- actions -->
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnSOS" class="btn">ğŸ†˜ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù† â€” Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button id="btnCopy" class="btn ghost">Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
        <button id="btnSMS" class="btn ghost">ÙØªØ­ SMS (Ù†Ø³Ø®Ø©)</button>

        <!-- Ø²Ø± ØªØ´ØºÙŠÙ„ ØªØªØ¨Ø¹ Ø­ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© -->
        <button id="btnStartTrack" class="btn ghost">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©</button>
        <button id="btnStopTrack" class="btn ghost" style="display:none">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹</button>
      </div>

      <p class="note">Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©: Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù† ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ø¦Ù„ ÙØ¹Ù„ÙŠØ© â€” Ø³ÙŠØªÙ… ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨/SMS ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø¶ØºØ· "Ø¥Ø±Ø³Ø§Ù„" Ø¯Ø§Ø®Ù„ ÙˆØ§ØªØ³Ø§Ø¨/Ø§Ù„ØªØ·Ø¨ÙŠÙ‚). Ø§Ù„ØªØªØ¨Ø¹ ÙŠØ¹Ù…Ù„ Ø·Ø§Ù„Ù…Ø§ Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø© Ø£Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª ÙˆÙ…ÙØªÙˆØ­.</p>
    </div>
  </div>

<script>
/* ===== register serviceWorker (PWA) ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('SW registered', reg.scope))
      .catch(err => console.warn('SW reg failed', err));
  });
}

/* ===== helpers & storage keys ===== */
const qs = id => document.getElementById(id);
const norm = s => s ? s.replace(/\D/g,'') : '';
const USER_SESSION_KEY = 'rescuer_current_v2';
let trackingIntervalId = null;
let lastCoords = null; // {lat, lon}

/* ===== Auth ===== */
qs('register').onclick = () => {
  const u = qs('username').value.trim(), p = qs('password').value;
  if(!u || !p) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆÙ…ÙØªØ§Ø­ (ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±)');
  if(localStorage.getItem('rescuer_'+u)) return alert('Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…');
  localStorage.setItem('rescuer_'+u, JSON.stringify({password:p, contacts:[], emergencyText:''}));
  localStorage.setItem(USER_SESSION_KEY, u);
  startSession(u);
};
qs('login').onclick = () => {
  const u = qs('username').value.trim(), p = qs('password').value;
  const raw = localStorage.getItem('rescuer_'+u); if(!raw) return alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const data = JSON.parse(raw); if(data.password !== p) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£');
  localStorage.setItem(USER_SESSION_KEY, u);
  startSession(u);
};
qs('logout').onclick = () => {
  if(confirm('ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ØŸ')) {
    localStorage.removeItem(USER_SESSION_KEY);
    endSession();
  }
};

function startSession(u){
  const raw = localStorage.getItem('rescuer_'+u);
  const data = raw ? JSON.parse(raw) : {password:'',contacts:[],emergencyText:''};
  qs('auth').style.display = 'none'; qs('panel').style.display = 'block';
  qs('who').innerText = 'Ù…Ø±Ø­Ø¨Ù‹Ø§ ' + u;
  qs('emergencyText').value = data.emergencyText || '';
  const tbody = qs('contactsTable').querySelector('tbody'); tbody.innerHTML = '';
  (data.contacts||[]).forEach(c => addRow(c));
  updateStatus('Ø¬Ø§Ù‡Ø²');
}
function endSession(){
  stopTracking();
  qs('auth').style.display = 'block'; qs('panel').style.display = 'none';
  qs('username').value=''; qs('password').value=''; qs('emergencyText').value='';
  updateStatus('ØºÙŠØ± Ù…Ø³Ø¬Ù„');
}

window.addEventListener('load', ()=> {
  const cur = localStorage.getItem(USER_SESSION_KEY);
  if(cur) startSession(cur);
});

/* ===== contacts ===== */
function getCurrentUserData(){ const u = localStorage.getItem(USER_SESSION_KEY); if(!u) return null; const raw = localStorage.getItem('rescuer_'+u); return raw?JSON.parse(raw):null; }
function saveCurrentUserData(data){ const u = localStorage.getItem(USER_SESSION_KEY); if(!u) return; localStorage.setItem('rescuer_'+u, JSON.stringify(data)); }

function addRow(c){
  const tbody = qs('contactsTable').querySelector('tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td style="width:70px"><input type="checkbox" data-id="${c.id}"></td><td>${c.name}</td><td>${c.phone}</td>
                  <td><button class="btn ghost" data-del="${c.id}">Ø­Ø°Ù</button></td>`;
  tbody.appendChild(tr);
  tr.querySelector('button[data-del]').onclick = () => {
    if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…ØŸ')) return;
    tr.remove();
    const d = getCurrentUserData(); if(!d) return;
    d.contacts = (d.contacts||[]).filter(x => x.id !== c.id);
    saveCurrentUserData(d);
  };
}

qs('addContact').onclick = () => {
  const name = qs('c_name').value.trim();
  const phoneRaw = qs('c_phone').value.trim();
  const phone = norm(phoneRaw);
  if(!name || !phone) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆØ±Ù‚Ù… ØµØ§Ù„Ø­');
  const id = Date.now().toString();
  const contact = { id, name, phone };
  addRow(contact);
  const d = getCurrentUserData() || {password:'',contacts:[],emergencyText:''};
  d.contacts = d.contacts || []; d.contacts.push(contact);
  saveCurrentUserData(d);
  qs('c_name').value=''; qs('c_phone').value='';
};

qs('emergencyText').addEventListener('change', ()=>{
  const d = getCurrentUserData(); if(!d) return;
  d.emergencyText = qs('emergencyText').value; saveCurrentUserData(d);
});

/* ===== status UI ===== */
function updateStatus(text){ qs('status').innerText = text; }

/* ===== geolocation helpers ===== */
function getLocationOnce(timeout=8000){
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation) return reject('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹');
    navigator.geolocation.getCurrentPosition(pos => {
      resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude });
    }, err => reject(err), { enableHighAccuracy: true, timeout });
  });
}

/* build message with coords */
function buildMessageText(baseMsg, lat, lon){
  const coords = (lat && lon) ? `Ù…ÙˆÙ‚Ø¹ÙŠ: https://www.google.com/maps?q=${lat.toFixed(6)},${lon.toFixed(6)}` : '(Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­)';
  return `${baseMsg} ${coords}`;
}

/* ==== send/open functions ==== */
/* open wa.me sequentially (needs user gesture to avoid popup blocking)
   We'll open each chat with small delay. */
function openWhatsAppsFor(phones, message) {
  if (!phones || phones.length === 0) return;
  phones.forEach((phone, index) => {
    const clean = phone.replace(/\D/g, '');
    const url = `https://wa.me/${encodeURIComponent(clean)}?text=${encodeURIComponent(message)}`;
    // ØªØ£Ø®ÙŠØ± Ù…ØªØ²Ø§ÙŠØ¯ Ù„Ù…Ù†Ø¹ Ø­Ø¸Ø± Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    setTimeout(() => {
      window.open(url, '_blank');
    }, index * 800);
  });

  // Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŒ Ø§ÙØªØ­ SMS ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ø³ÙŠØ­Ø§ÙˆÙ„ ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„)
  const smsNumbers = phones.join(',');
  setTimeout(() => {
    try { window.open(`sms:${smsNumbers}?body=${encodeURIComponent(message)}`, '_blank'); } catch(e){ console.warn('ÙØªØ­ SMS ÙØ´Ù„', e); }
  }, phones.length * 900);
}

/* get selected phones or all */
function getSelectedPhones(){
  const tbody = qs('contactsTable').querySelector('tbody');
  const checks = Array.from(tbody.querySelectorAll('input[type=checkbox]:checked'));
  const phones = checks.map(ch => ch.closest('tr').cells[2].innerText.trim()).filter(Boolean);
  if(phones.length === 0){
    const d = getCurrentUserData();
    if(d && d.contacts) return d.contacts.map(c => c.phone);
    return [];
  }
  return phones;
}

/* ==== Immediate SOS (one-off) ==== */
qs('btnSOS').onclick = async () => {
  if(!localStorage.getItem(USER_SESSION_KEY)) return alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
  updateStatus('Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹...');
  const baseMsg = qs('emergencyText').value.trim() || (getCurrentUserData() && getCurrentUserData().emergencyText) || 'Ø£Ù†Ø§ ÙÙŠ Ø®Ø·Ø±! Ø£Ø­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©!';
  let lat=null, lon=null;
  try {
    const pos = await getLocationOnce(8000);
    lat = pos.lat; lon = pos.lon;
  } catch(e){
    console.warn('Ù…ÙƒØ§Ù† ØºÙŠØ± Ù…ØªØ§Ø­', e);
  }
  const msg = buildMessageText(baseMsg, lat, lon);
  const phones = getSelectedPhones();
  if(phones.length === 0) { alert('Ù„Ø§ Ø£Ø±Ù‚Ø§Ù… Ù…Ø³Ø¬Ù„Ø© Ø£Ùˆ Ù…Ø®ØªØ§Ø±Ø©'); updateStatus('Ø¬Ø§Ù‡Ø²'); return; }
  updateStatus('ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨...');
  openWhatsAppsFor(phones, msg);
  setTimeout(()=> updateStatus('ØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ± â€” Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª'), phones.length * 900);
};

/* ==== Copy and SMS buttons ==== */
qs('btnCopy').onclick = async () => {
  const base = qs('emergencyText').value.trim() || (getCurrentUserData() && getCurrentUserData().emergencyText) || 'Ø£Ù†Ø§ ÙÙŠ Ø®Ø·Ø±!';
  let lat=null, lon=null;
  try { const p = await getLocationOnce(5000); lat=p.lat; lon=p.lon; } catch(e){ console.warn('no loc', e); }
  const msg = buildMessageText(base, lat, lon);
  try {
    await navigator.clipboard.writeText(msg);
    alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
  } catch(e) {
    const ta = document.createElement('textarea'); ta.value = msg; document.body.appendChild(ta); ta.select();
    try { document.execCommand('copy'); alert('ØªÙ… Ø§Ù„Ù†Ø³Ø® (fallback)'); } catch(err){ alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®'); }
    ta.remove();
  }
};

qs('btnSMS').onclick = async () => {
  if(!localStorage.getItem(USER_SESSION_KEY)) return alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
  updateStatus('Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹...');
  let lat=null, lon=null;
  try { const p = await getLocationOnce(8000); lat=p.lat; lon=p.lon; } catch(e){ console.warn('no loc', e); }
  const base = qs('emergencyText').value.trim() || (getCurrentUserData() && getCurrentUserData().emergencyText) || 'Ø£Ù†Ø§ ÙÙŠ Ø®Ø·Ø±!';
  const msg = buildMessageText(base, lat, lon);
  try { window.open(`sms:?&body=${encodeURIComponent(msg)}`, '_blank'); } catch(e){ alert('ØªØ¹Ø°Ø± ÙØªØ­ SMS'); }
  updateStatus('Ø¬Ø§Ù‡Ø²');
};

/* ==== Live tracking every 30s (sends when coords change) ==== */
async function sendLocationToContactsIfChanged(lat, lon){
  const baseMsg = qs('emergencyText').value.trim() || (getCurrentUserData() && getCurrentUserData().emergencyText) || 'Ø£Ù†Ø§ ÙÙŠ Ø®Ø·Ø±! Ø£Ø­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©!';
  const coordsStr = `${lat.toFixed(6)},${lon.toFixed(6)}`;
  if (!lastCoords || lastCoords !== coordsStr) {
    lastCoords = coordsStr;
    const msg = buildMessageText(baseMsg, lat, lon);
    const phones = getSelectedPhones();
    if(phones.length === 0) {
      console.warn('Ù„Ø§ Ø£Ø±Ù‚Ø§Ù… Ù…Ø³Ø¬Ù„Ø©');
      updateStatus('Ù„Ø§ Ø£Ø±Ù‚Ø§Ù… Ù…Ø³Ø¬Ù„Ø©');
      return;
    }
    updateStatus('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„...');
    // Ø§ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙƒÙ„ Ø±Ù‚Ù…
    openWhatsAppsFor(phones, msg);
    setTimeout(()=> updateStatus('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â€” Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª'), phones.length * 900);
  } else {
    console.log('Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù… ÙŠØªØºÙŠØ±');
    updateStatus('Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù… ÙŠØªØºÙŠØ±');
  }
}

async function startTracking(){
  if(!localStorage.getItem(USER_SESSION_KEY)) return alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
  if (!navigator.geolocation) return alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
  if (trackingIntervalId) return; // already running

  // user gesture: we start tracking after Ø²Ø± Ø§Ù„Ø¶ØºØ· (browser allows opening windows later)
  updateStatus('Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ â€” Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹...');
  try {
    // Ø·Ù„Ø¨ Ø£ÙˆÙ„ Ù…ÙˆÙ‚Ø¹ ÙÙˆØ±ÙŠ
    const p = await getLocationOnce(10000);
    await sendLocationToContactsIfChanged(p.lat, p.lon);
  } catch(e){
    console.warn('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ', e);
    alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.');
    updateStatus('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
    return;
  }

  // Ø§Ù„Ø¢Ù† Ù†ÙØªØ­ interval ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
  trackingIntervalId = setInterval(async () => {
    try {
      const p = await getLocationOnce(8000);
      await sendLocationToContactsIfChanged(p.lat, p.lon);
    } catch(e){
      console.warn('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØªØ¨Ø¹', e);
      updateStatus('ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
    }
  }, 30000); // 30000 Ù…Ù„Ù„ÙŠ = 30 Ø«Ø§Ù†ÙŠØ©

  qs('btnStartTrack').style.display = 'none';
  qs('btnStopTrack').style.display = 'inline-block';
  updateStatus('Ø§Ù„ØªØªØ¨Ø¹ ÙŠØ¹Ù…Ù„ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©');
}

function stopTracking(){
  if(trackingIntervalId) {
    clearInterval(trackingIntervalId);
    trackingIntervalId = null;
    updateStatus('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹');
  }
  qs('btnStartTrack').style.display = 'inline-block';
  qs('btnStopTrack').style.display = 'none';
  lastCoords = null;
}

/* bind start/stop */
qs('btnStartTrack').onclick = () => {
  // Ù†Ù†Ø¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ÙŠÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªØºÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹
  if(!confirm('Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©. Ø¹Ù†Ø¯ ØªØºÙŠÙ‘Ø± Ù…ÙˆÙ‚Ø¹Ùƒ Ø³ÙŠØªÙ… ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ø³ØªØ­ØªØ§Ø¬ Ù„Ù„Ø¶ØºØ· "Ø¥Ø±Ø³Ø§Ù„" Ø¯Ø§Ø®Ù„ ÙˆØ§ØªØ³Ø§Ø¨). Ù…ÙˆØ§ÙÙ‚ØŸ')) return;
  startTracking();
};
qs('btnStopTrack').onclick = () => {
  stopTracking();
};

/* safety: Ø¹Ù†Ø¯ ØºÙ„Ù‚ Ø§Ù„ØµÙØ­Ø© Ù†ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ø£ÙˆÙ‚ÙÙ†Ø§ Ø§Ù„ØªØªØ¨Ø¹ */
window.addEventListener('beforeunload', () => {
  stopTracking();
});
</script>
</body>
</html>
