<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ğŸš¨ Ø§Ù„Ù…Ù†Ù‚Ø° Ø§Ù„Ø°ÙƒÙŠ â€” Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹ (ÙˆØ§ØªØ³Ø§Ø¨)</title>
<style>
  :root{--accent:#d93b3b;--muted:#666}
  *{box-sizing:border-box}
  body{font-family:"Tajawal",system-ui,sans-serif;direction:rtl;margin:0;background:#fff;padding:18px;color:#111;display:flex;justify-content:center}
  .wrap{width:100%;max-width:840px}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{color:var(--accent);margin:0;font-size:1.15rem}
  small{color:var(--muted)}
  .card{background:#fff;border:1px solid #f3eaea;padding:14px;border-radius:10px;margin-top:12px;box-shadow:0 4px 16px rgba(0,0,0,0.03)}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input,textarea,select,button{font-size:1rem}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e9e9e9}
  textarea{min-height:70px;resize:vertical}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:#f6f6f6;color:#222;border:1px solid #eee}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.95rem}
  th,td{padding:8px;border-bottom:1px solid #f4f4f4;text-align:right}
  th{color:var(--accent);font-weight:700}
  .note{color:var(--muted);font-size:0.9rem;margin-top:8px}
  @media(max-width:520px){.row{flex-direction:column}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸš¨ Ø§Ù„Ù…Ù†Ù‚Ø° Ø§Ù„Ø°ÙƒÙŠ â€” Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹</h1>
      <small>Ù†Ø³Ø®Ø© Ø®ÙÙŠÙØ©: Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ / SMS</small>
    </header>

    <div id="auth" class="card">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input id="username" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§"/>
      <label style="margin-top:8px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"/>
      <div class="row" style="margin-top:10px">
        <button id="register" class="btn">Ø³Ø¬Ù‘Ù„</button>
        <button id="login" class="btn ghost">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <p class="note">ÙŠÙØ­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·.</p>
    </div>

    <div id="panel" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong id="who"></strong>
          <div class="note" id="status">Ø¬Ø§Ù‡Ø²</div>
        </div>
        <button id="logout" class="btn ghost">Ø®Ø±ÙˆØ¬</button>
      </div>

      <div style="margin-top:12px">
        <label>Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</label>
        <textarea id="emergencyText" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø£Ù†Ø§ ÙÙŠ Ø®Ø·Ø±ØŒ Ø£Ø­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙˆØ±Ù‹Ø§!"></textarea>
      </div>

      <div style="margin-top:12px">
        <label>Ø£Ø¶Ù Ø±Ù‚Ù… (Ø¨Ø¯ÙˆÙ† +)</label>
        <div class="row">
          <input id="c_name" placeholder="Ø§Ù„Ø§Ø³Ù…"/>
          <input id="c_phone" placeholder="Ø±Ù‚Ù… Ø¯ÙˆÙ„ÙŠ (Ù…Ø«Ù„Ø§Ù‹ 2010...)"/>
          <button id="addContact" class="btn">Ø£Ø¶Ù</button>
        </div>

        <table id="contactsTable">
          <thead><tr><th>Ø§Ø®ØªÙŠØ§Ø±</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø­Ø°Ù</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnSOS" class="btn">ğŸ†˜ Ø²Ø± SOS â€” ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button id="btnCopy" class="btn ghost">Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
        <button id="btnSMS" class="btn ghost">SMS</button>
      </div>
    </div>
  </div>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

const qs = id => document.getElementById(id);
const norm = s => s ? s.replace(/\D/g,'') : '';
const USER_KEY = 'rescuer_current_v2';

/* ===== Ø§Ù„ØªØ³Ø¬ÙŠÙ„ / Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
qs('register').onclick = () => {
  const u = qs('username').value.trim(), p = qs('password').value;
  if(!u || !p) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±');
  if(localStorage.getItem('rescuer_'+u)) return alert('Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…');
  localStorage.setItem('rescuer_'+u, JSON.stringify({password:p, contacts:[], emergencyText:''}));
  localStorage.setItem(USER_KEY, u);
  startSession(u);
};
qs('login').onclick = () => {
  const u = qs('username').value.trim(), p = qs('password').value;
  const raw = localStorage.getItem('rescuer_'+u);
  if(!raw) return alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const data = JSON.parse(raw);
  if(data.password !== p) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø·Ø£');
  localStorage.setItem(USER_KEY, u);
  startSession(u);
};
qs('logout').onclick = () => {
  if(confirm('ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ØŸ')) {
    localStorage.removeItem(USER_KEY);
    endSession();
  }
};

function startSession(u){
  const data = JSON.parse(localStorage.getItem('rescuer_'+u));
  qs('auth').style.display = 'none';
  qs('panel').style.display = 'block';
  qs('who').innerText = 'Ù…Ø±Ø­Ø¨Ù‹Ø§ ' + u;
  qs('emergencyText').value = data.emergencyText || '';
  const tbody = qs('contactsTable').querySelector('tbody');
  tbody.innerHTML = '';
  (data.contacts||[]).forEach(c => addRow(c));
}
function endSession(){
  qs('auth').style.display = 'block';
  qs('panel').style.display = 'none';
}

window.addEventListener('load', ()=> {
  const cur = localStorage.getItem(USER_KEY);
  if(cur) startSession(cur);
});

/* ===== Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ===== */
function getUserData(){ 
  const u = localStorage.getItem(USER_KEY); 
  if(!u) return null; 
  return JSON.parse(localStorage.getItem('rescuer_'+u)); 
}
function saveUserData(d){ 
  const u = localStorage.getItem(USER_KEY); 
  if(u) localStorage.setItem('rescuer_'+u, JSON.stringify(d)); 
}
function addRow(c){
  const tbody = qs('contactsTable').querySelector('tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><input type="checkbox" data-id="${c.id}"></td><td>${c.name}</td><td>${c.phone}</td>
                  <td><button class="btn ghost" data-del="${c.id}">Ø­Ø°Ù</button></td>`;
  tbody.appendChild(tr);
  tr.querySelector('button[data-del]').onclick = () => {
    if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…ØŸ')) return;
    tr.remove();
    const d = getUserData();
    d.contacts = d.contacts.filter(x => x.id !== c.id);
    saveUserData(d);
  };
}
qs('addContact').onclick = () => {
  const name = qs('c_name').value.trim();
  const phone = norm(qs('c_phone').value.trim());
  if(!name || !phone) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆØ±Ù‚Ù…');
  const c = {id: Date.now().toString(), name, phone};
  addRow(c);
  const d = getUserData();
  d.contacts.push(c);
  saveUserData(d);
  qs('c_name').value=''; qs('c_phone').value='';
};
qs('emergencyText').onchange = () => {
  const d = getUserData();
  d.emergencyText = qs('emergencyText').value;
  saveUserData(d);
};

/* ===== Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ===== */
function getSelectedPhones(){
  const tbody = qs('contactsTable').querySelector('tbody');
  const checks = Array.from(tbody.querySelectorAll('input[type=checkbox]:checked'));
  const phones = checks.map(ch => ch.closest('tr').cells[2].innerText.trim());
  if(phones.length === 0){
    const d = getUserData();
    return d.contacts.map(c=>c.phone);
  }
  return phones;
}

qs('btnSOS').onclick = async () => {
  const phones = getSelectedPhones();
  if(phones.length === 0) return alert('Ø£Ø¶Ù Ø±Ù‚Ù… Ø£ÙˆÙ„Ø§Ù‹');
  const msg = qs('emergencyText').value.trim() || 'Ø£Ù†Ø§ ÙÙŠ Ø®Ø·Ø±! Ø£Ø­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙˆØ±Ù‹Ø§!';
  qs('status').innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
  let i = 0;
  const sendNext = () => {
    if(i < phones.length){
      const url = `https://wa.me/${phones[i]}?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
      i++;
      setTimeout(sendNext, 2000); // 2 Ø«Ø§Ù†ÙŠØ©
    } else {
      qs('status').innerText = 'âœ… ØªÙ… ÙØªØ­ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª';
    }
  };
  sendNext();
};
</script>
</body>
</html>
